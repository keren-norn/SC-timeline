<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fusion overrides (TikiToki / SC timeline)</title>
  <style>
    :root{--bg:#0b0e14;--panel:#0f1522;--border:rgba(255,255,255,.08);--text:#eaeaea;--muted:#9aa4b2;--accent:#00b4ff;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    header{padding:14px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(11,14,20,.92);backdrop-filter:blur(10px);z-index:10}
    header h1{margin:0;font-size:18px;font-weight:900}
    header p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.35}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .hd{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:900}
    .bd{padding:12px 14px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="file"], select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);background:#0b1222;color:var(--text)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1222;color:var(--text);cursor:pointer}
    button.primary{border-color:rgba(0,180,255,.55);box-shadow:0 0 0 3px rgba(0,180,255,.15)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .out{white-space:pre-wrap;background:#0b1222;border:1px solid var(--border);border-radius:12px;padding:10px;color:var(--text);min-height:120px}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:12px;margin-right:8px;margin-bottom:8px}
    .warn{color:#ffd27a}
  </style>
</head>
<body>
<header>
  <h1>üß© Fusion d‚Äôoverrides (JSON)</h1>
  <p>
    Charge deux fichiers d‚Äôoverrides export√©s depuis votre viewer. Puis g√©n√®re un <b>JSON fusionn√©</b> t√©l√©chargeable.<br/>
    <span class="warn">R√®gle par d√©faut :</span> ‚ÄúB √©crase A‚Äù en cas de conflit (modifiable ci-dessous).
  </p>
</header>

<div class="wrap">
  <section class="card">
    <div class="hd">1) Charger les deux JSON</div>
    <div class="bd">
      <div class="row">
        <div>
          <label for="fileA">Fichier A (ex: tes modifs)</label>
          <input id="fileA" type="file" accept="application/json" />
        </div>
        <div>
          <label for="fileB">Fichier B (ex: modifs de ton ami)</label>
          <input id="fileB" type="file" accept="application/json" />
        </div>
      </div>

      <div style="margin-top:12px">
        <label for="mode">Strat√©gie de conflit</label>
        <select id="mode">
          <option value="b_wins">B √©crase A (recommand√©)</option>
          <option value="a_wins">A √©crase B</option>
          <option value="merge_fields_b">Fusion champ par champ (B gagne par champ)</option>
          <option value="merge_fields_a">Fusion champ par champ (A gagne par champ)</option>
        </select>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="primary" id="mergeBtn" type="button">Fusionner</button>
        <button id="downloadBtn" type="button" disabled>T√©l√©charger JSON fusionn√©</button>
        <button id="copyBtn" type="button" disabled>Copier JSON fusionn√©</button>
      </div>

      <div style="margin-top:12px" id="stats"></div>
    </div>
  </section>

  <section class="card">
    <div class="hd">2) R√©sultat (aper√ßu)</div>
    <div class="bd">
      <div class="out mono" id="preview">(charge A et B puis clique ‚ÄúFusionner‚Äù)</div>
    </div>
  </section>
</div>

<script>
let merged = null;

function safeJsonParse(text){
  try { return JSON.parse(text); } catch(e){ throw new Error("JSON invalide : " + e.message); }
}

function isObj(x){ return x && typeof x === "object" && !Array.isArray(x); }

function deepMergeFieldWise(base, incoming, incomingWins=true){
  const out = isObj(base) ? {...base} : (isObj(incoming) ? {...incoming} : {});
  if (!isObj(base) && isObj(incoming)) return {...incoming};
  if (isObj(base) && !isObj(incoming)) return {...base};

  const keys = new Set([...Object.keys(base||{}), ...Object.keys(incoming||{})]);
  for (const k of keys){
    const a = base ? base[k] : undefined;
    const b = incoming ? incoming[k] : undefined;

    if (isObj(a) && isObj(b)){
      out[k] = deepMergeFieldWise(a, b, incomingWins);
    } else if (b === undefined){
      out[k] = a;
    } else if (a === undefined){
      out[k] = b;
    } else {
      out[k] = incomingWins ? b : a;
    }
  }
  return out;
}

function mergeOverrides(A, B, mode){
  if (!isObj(A) || !isObj(B)) throw new Error("Les overrides doivent √™tre des objets JSON { storyId: {...}, ... }");

  const out = {};
  const ids = new Set([...Object.keys(A), ...Object.keys(B)]);

  for (const id of ids){
    const a = A[id];
    const b = B[id];

    if (a === undefined) { out[id] = b; continue; }
    if (b === undefined) { out[id] = a; continue; }

    if (mode === "a_wins"){
      out[id] = a;
    } else if (mode === "b_wins"){
      out[id] = b;
    } else if (mode === "merge_fields_b"){
      out[id] = deepMergeFieldWise(a, b, true);
    } else if (mode === "merge_fields_a"){
      out[id] = deepMergeFieldWise(a, b, false);
    } else {
      out[id] = b;
    }
  }

  return out;
}

async function readFileAsText(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = ()=> reject(new Error("Lecture fichier impossible"));
    r.readAsText(file, "utf-8");
  });
}

function summarize(obj){
  const ids = Object.keys(obj||{});
  let deleted = 0, created = 0;
  for (const id of ids){
    const o = obj[id];
    if (!isObj(o)) continue;
    if (o.__deleted) deleted++;
    if (o.__new) created++;
  }
  return {count: ids.length, deleted, created};
}

function setStats(a,b,m){
  const el = document.getElementById("stats");
  const pa = summarize(a);
  const pb = summarize(b);
  const pm = summarize(m);
  el.innerHTML = `
    <div class="pill">A: <b>${pa.count}</b> entr√©es ‚Ä¢ +${pa.created} new ‚Ä¢ ${pa.deleted} deleted</div>
    <div class="pill">B: <b>${pb.count}</b> entr√©es ‚Ä¢ +${pb.created} new ‚Ä¢ ${pb.deleted} deleted</div>
    <div class="pill">Fusion: <b>${pm.count}</b> entr√©es ‚Ä¢ +${pm.created} new ‚Ä¢ ${pm.deleted} deleted</div>
  `;
}

document.getElementById("mergeBtn").addEventListener("click", async ()=>{
  const fa = document.getElementById("fileA").files?.[0];
  const fb = document.getElementById("fileB").files?.[0];
  if (!fa || !fb){ alert("Choisis 2 fichiers JSON (A et B)."); return; }

  try{
    const [ta, tb] = await Promise.all([readFileAsText(fa), readFileAsText(fb)]);
    const A = safeJsonParse(ta);
    const B = safeJsonParse(tb);
    const mode = document.getElementById("mode").value;

    merged = mergeOverrides(A, B, mode);
    setStats(A,B,merged);

    const pretty = JSON.stringify(merged, null, 2);
    document.getElementById("preview").textContent = pretty.slice(0, 20000) + (pretty.length > 20000 ? "\n\n‚Ä¶(aper√ßu tronqu√©)‚Ä¶" : "");
    document.getElementById("downloadBtn").disabled = false;
    document.getElementById("copyBtn").disabled = false;
  } catch(e){
    console.error(e);
    alert(e.message || String(e));
  }
});

document.getElementById("downloadBtn").addEventListener("click", ()=>{
  if (!merged) return;
  const blob = new Blob([JSON.stringify(merged, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "tikitoki_edits_1771887_merged.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

document.getElementById("copyBtn").addEventListener("click", async ()=>{
  if (!merged) return;
  try{
    await navigator.clipboard.writeText(JSON.stringify(merged, null, 2));
    alert("JSON copi√© ‚úÖ");
  } catch(e){
    alert("Impossible de copier. Utilise le t√©l√©chargement √† la place.");
  }
});
</script>
</body>
</html>
