<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>L‚Äôhistoire de Star citizen ‚Äì viewer</title>
<style>
:root {
  --bg:#0b0e14; --panel:#0f1522; --panel2:#0c1220; --text:#eaeaea; --muted:#9aa4b2;
  --border:rgba(255,255,255,.08); --accent:#00b4ff;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{position:sticky;top:0;z-index:30;background:rgba(11,14,20,.92);backdrop-filter:blur(10px);
  border-bottom:1px solid var(--border);padding:14px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
header h1{margin:0;font-size:18px;font-weight:900}
header .meta{color:var(--muted);font-size:12px}
.wrap{display:grid;grid-template-columns:360px 1fr;gap:14px;max-width:1600px;margin:0 auto;padding:14px 16px 40px}
@media(max-width:980px){.wrap{grid-template-columns:1fr}}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
.hd{padding:12px 12px 10px;border-bottom:1px solid var(--border);background:var(--panel2);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.bd{padding:12px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input[type="text"],select,input[type="number"]{width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--border);
  background:#0b1222;color:var(--text);outline:none}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1222;color:var(--text);cursor:pointer}
button.primary{border-color:rgba(0,180,255,.55);box-shadow:0 0 0 3px rgba(0,180,255,.15)}
.stats{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
.pill{border:1px solid var(--border);padding:6px 8px;border-radius:999px;background:rgba(255,255,255,.03)}
.timeline{position:relative;padding-left:24px}
.timeline:before{content:"";position:absolute;left:10px;top:0;bottom:0;width:3px;background:rgba(0,180,255,.25);border-radius:999px}
.event{position:relative;margin:12px 0}
.event:before{content:"";position:absolute;left:3px;top:18px;width:16px;height:16px;border-radius:999px;background:var(--accent);
  box-shadow:0 0 0 4px rgba(0,180,255,.14)}
.evt{margin-left:20px;padding:12px 12px 10px;border-radius:16px;border:1px solid var(--border);background:var(--panel);
  box-shadow:0 10px 30px rgba(0,0,0,.22);cursor:pointer;display:flex;gap:12px;align-items:flex-start}
.evtMain{flex:1;min-width:0}
.evtThumb{width:110px;height:78px;border-radius:14px;overflow:hidden;border:1px solid var(--border);background:rgba(255,255,255,.03);flex:0 0 auto}
.evtThumb img{width:100%;height:100%;object-fit:cover;display:block}
.evtThumb.empty{display:none}
.evt:hover{border-color:rgba(255,255,255,.16)}
.date{color:var(--accent);font-size:12px;font-weight:900;letter-spacing:.2px}
.title{margin-top:6px;font-weight:900;font-size:16px}
.cat{margin-top:8px;display:inline-flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
.dot{width:10px;height:10px;border-radius:999px;display:inline-block}
.preview{margin-top:8px;line-height:1.35;color:var(--text);}
a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;z-index:100}
.modal{position:fixed;inset:0;display:none;z-index:101;place-items:center;padding:20px}
.modal .panel{width:min(980px, 96vw);max-height:86vh;overflow:auto;background:var(--panel);
  border:1px solid var(--border);border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.55);}
.modal .mhd{padding:12px 14px;border-bottom:1px solid var(--border);background:var(--panel2);
  display:flex;align-items:center;gap:10px;position:sticky;top:0}
.modal .mhd .spacer{flex:1}
.modal .close{border-radius:12px;padding:8px 10px}
.modal .mbd{padding:14px}
.modal .mdate{color:var(--accent);font-weight:900;font-size:12px}
.modal .mtitle{margin-top:6px;font-weight:950;font-size:20px}
.modal .mcat{margin-top:10px;color:var(--muted);font-size:12px;display:flex;align-items:center;gap:8px}
.modal .mtext{margin-top:12px;line-height:1.5;white-space:pre-wrap}
.modal .links{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
.gallery{margin-top:14px;display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
.thumb{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.03)}
.thumb img{width:100%;height:120px;object-fit:cover;display:block}
.thumb .cap{padding:8px;font-size:12px;color:var(--muted)}

/* --- Hybrid edit UI --- */
.mhd .btn{border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);padding:8px 10px;border-radius:10px;font-weight:800;cursor:pointer}
.mhd .btn.primary{background:linear-gradient(180deg, rgba(0,180,255,.24), rgba(0,180,255,.08));border-color:rgba(0,180,255,.35)}
.mhd .btn.danger{background:linear-gradient(180deg, rgba(255,80,80,.18), rgba(255,80,80,.06));border-color:rgba(255,80,80,.35)}
#editWrap{display:none;margin-top:12px}
#editWrap .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
#editWrap label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
#editWrap input,#editWrap select,#editWrap textarea{width:100%;box-sizing:border-box;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--text);outline:none}
#editWrap textarea{min-height:140px;resize:vertical}
#editHelp{color:var(--muted);font-size:12px;line-height:1.35;margin-top:8px}

</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <div>
    <h1 id="pageTitle"></h1>
    <div class="meta" id="pageMeta"></div>
  </div>
</header>

<div class="wrap">
  <section class="card">
    <div class="hd"><b>Filtres</b></div>
    <div class="bd">
      <div style="margin-bottom:12px">
        <label for="q">Recherche (titre / texte)</label>
        <input id="q" type="text" placeholder="ex: UEE, Jump Point, Xi'an, CitizenCon..." />
      </div>
      <div style="margin-bottom:12px">
        <label for="cat">Cat√©gorie</label>
        <select id="cat"></select>
      </div>
      <div class="row" style="margin-bottom:12px">
        <div><label for="y1">Ann√©e min</label><input id="y1" type="number" /></div>
        <div><label for="y2">Ann√©e max</label><input id="y2" type="number" /></div>
      </div>
      <div class="row" style="margin-bottom:12px">
        <button id="resetBtn">R√©initialiser</button>
        <button id="copyBtn" class="primary">Copier JSON filtr√©</button>
      </div>
      <div class="stats" id="stats"></div>

      <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="exportEditsBtn" class="primary" type="button">Exporter (JSON)</button>
          <button id="importEditsBtn" type="button">Importer (JSON)</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="exportSnapshotBtn" type="button">Export snapshot (GitHub)</button>
          <button id="reloadSupabaseBtn" type="button">Recharger (Supabase)</button>
        </div>
        <div id="sbStatus" class="muted" style="margin-top:8px;font-size:12px">Supabase: ‚Äî</div>

        <div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border)">
          <div class="muted" style="font-size:12px;margin-bottom:8px">Acc√®s √©dition (Supabase)</div>
          <div class="row" style="grid-template-columns:1fr;gap:8px">
            <input id="authEmail" type="email" placeholder="email" style="width:100%"/>
            <input id="authCode" type="text" placeholder="code (si OTP)" style="width:100%"/>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="loginBtn" type="button">Se connecter</button>
            <button id="logoutBtn" type="button" disabled>Se d√©connecter</button>
          </div>
          <div id="authStatus" class="muted" style="margin-top:8px;font-size:12px">Mode: lecture</div>
          <div id="lastChange" class="muted" style="margin-top:6px;font-size:12px"></div>
        </div>

        <input id="importFile" type="file" accept="application/json" style="display:none"/>
        <div style="margin-top:8px;color:var(--muted);font-size:12px;line-height:1.35">
          Exporte / importe uniquement les modifications (stock√©es dans ton navigateur).
        </div>
      </div>
      <div style="margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35">
        Clique un √©v√©nement pour ouvrir la fiche (overlay style Tiki-Toki).
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd"><b>Timeline</b></div>
    <div class="bd"><div class="timeline" id="timeline"></div></div>
  </section>
</div>

<div class="modal-backdrop" id="backdrop"></div>
<div class="modal" id="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="mhd">
      <div style="font-weight:900">Story</div>
      <div class="spacer"></div>
      <button class="btn" id="newBtn" title="Nouvel √©v√©nement">+ Nouveau</button>
      <button class="btn" id="editBtn" title="√âditer cet √©v√©nement">‚úé √âditer</button>
      <button class="btn primary" id="saveBtn" style="display:none" title="Sauvegarder">‚úì Sauver</button>
      <button class="btn" id="cancelBtn" style="display:none" title="Annuler">‚Ü© Annuler</button>
      <button class="btn danger" id="deleteBtn" title="Supprimer">üóë</button>
      <button class="close" id="closeBtn">Fermer</button>
    </div>
    <div class="mbd">
      <div class="mdate" id="mdate"></div>
      <div class="mtitle" id="mtitle"></div>
      <div class="mcat"><span class="dot" id="mdot"></span><span id="mcat"></span></div>
      <div class="links" id="mlinks"></div>
      <div class="mtext" id="mtext"></div>
      <div class="gallery" id="mgallery"></div>

      <div id="editWrap">
        <div class="grid">
          <div>
            <label for="e_title">Titre</label>
            <input id="e_title" type="text" />
          </div>
          <div>
            <label for="e_cat">Cat√©gorie</label>
            <select id="e_cat"></select>
          </div>
          <div>
            <label for="e_start">D√©but (YYYY-MM-DD HH:MM:SS)</label>
            <input id="e_start" type="text" placeholder="2951-01-01 00:00:00" />
          </div>
          <div>
            <label for="e_end">Fin (optionnel)</label>
            <input id="e_end" type="text" placeholder="2951-01-01 00:00:00" />
          </div>
          <div>
            <label for="e_link">Lien externe</label>
            <input id="e_link" type="text" placeholder="https://..." />
          </div>
          <div>
            <label for="e_img">Image (URL)</label>
            <input id="e_img" type="text" placeholder="https://...jpg" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label for="e_text">Texte (long)</label>
          <textarea id="e_text"></textarea>
        </div>
        <div id="editHelp">Astuce: pour que l‚Äôimage apparaisse √† droite dans la liste, mets une URL d‚Äôimage dans ‚ÄúImage (URL)‚Äù.</div>
      </div>
    </div>
  </div>
</div>

<script>
// --- Base JSON (GitHub) ---
const BASE_JSON_URL = "./data/tiki_toki_1771887.json";
let DATA = null;
let meta = null;
let cats = [];
let stories = [];
let BASE_STORIES = [];
let catMap = new Map();

async function loadBaseJson(){
  const r = await fetch(BASE_JSON_URL, { cache: 'no-store' });
  if (!r.ok) throw new Error(`Base JSON introuvable: ${BASE_JSON_URL} (HTTP ${r.status})`);
  DATA = await r.json();
  meta = DATA.meta || {};
  cats = Array.isArray(DATA.categories) ? DATA.categories : [];
  stories = Array.isArray(DATA.stories) ? DATA.stories : [];
  BASE_STORIES = JSON.parse(JSON.stringify(stories));
  catMap = new Map(cats.map(c => [String(c.id), c]));
}


/**
 * Liens manuels (optionnel)
 * Format:
 *   storyId: [{ title: "Wikipedia", url: "https://..." }, ...]
 */
const MANUAL_SOURCES = {
  // 18828121: [{title:"Spoutnik 1 (Wikip√©dia)", url:"https://fr.wikipedia.org/wiki/Spoutnik_1"}],
};

// --- Overrides compatibles avec l'√©diteur add_events ---
const LS_KEY = "tikitoki_overrides_1771887_v2";

function loadOverrides(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch(e){
    console.warn("Overrides load failed", e);
    return {};
  }
}

function getManualLinksForStory(story){
  // 1) liens enregistr√©s via add_events (dans OVERRIDES) et inject√©s en __manualLinks
  if (story && Array.isArray(story.__manualLinks)) return story.__manualLinks;
  // 2) liens cod√©s en dur ici
  const m = MANUAL_SOURCES[String(story.id)];
  return Array.isArray(m) ? m : [];
}

let OVERRIDES = loadOverrides();

function rebuildStoriesFromBase(){
  stories = JSON.parse(JSON.stringify(BASE_STORIES));
  const byId = new Map(stories.map(s => [String(s.id), s]));

  for (const [id, o] of Object.entries(OVERRIDES)){
    if (!o || typeof o !== "object") continue;

    if (o.__new){
      const ns = {
        id: parseInt(id, 10) || id,
        title: o.title || "(sans titre)",
        startDate: o.startDate || "",
        endDate: o.endDate || "",
        category: o.category || "",
        fullTextResolved: o.fullTextResolved || "",
        textResolved: o.textResolved || "",
        tags: o.tags || "",
        externalLink: o.externalLink || "",
        media: Array.isArray(o.media) ? o.media : []
      };
      if (Array.isArray(o.manualLinks)) ns.__manualLinks = o.manualLinks;
      stories.push(ns);
      continue;
    }

    const s = byId.get(String(id));
    if (!s) continue;

    if (o.__deleted){
      s.__deleted = true;
      continue;
    }

    if (typeof o.title === "string") s.title = o.title;
    if (typeof o.startDate === "string") s.startDate = o.startDate;
    if (typeof o.endDate === "string") s.endDate = o.endDate;
    if (typeof o.category === "string") s.category = o.category;
    if (typeof o.fullTextResolved === "string") s.fullTextResolved = o.fullTextResolved;
    if (typeof o.textResolved === "string") s.textResolved = o.textResolved;
    if (typeof o.tags === "string") s.tags = o.tags;
    if (typeof o.externalLink === "string") s.externalLink = o.externalLink;
    if (Array.isArray(o.media)) s.media = o.media;
    if (Array.isArray(o.manualLinks)) s.__manualLinks = o.manualLinks;
  }
}


// --- Hybrid edit mode (inline) ---
function saveOverrides(obj){
  localStorage.setItem(LS_KEY, JSON.stringify(obj));
}

let CURRENT_STORY_ID = null;
let EDIT_MODE = false;

function fillEditCategorySelect(selected){
  const sel = document.getElementById('e_cat');
  sel.innerHTML = '';
  const sorted = [...cats].sort((a,b)=> (a.title||'').localeCompare(b.title||'', 'fr'));
  for (const c of sorted){
    const o = document.createElement('option');
    o.value = String(c.id);
    o.textContent = c.title || String(c.id);
    sel.appendChild(o);
  }
  sel.value = selected ? String(selected) : '';
}

function setEditMode(on){
  EDIT_MODE = !!on;
  document.getElementById('editWrap').style.display = EDIT_MODE ? 'block' : 'none';
  document.getElementById('editBtn').style.display = EDIT_MODE ? 'none' : 'inline-block';
  document.getElementById('saveBtn').style.display = EDIT_MODE ? 'inline-block' : 'none';
  document.getElementById('cancelBtn').style.display = EDIT_MODE ? 'inline-block' : 'none';

  document.getElementById('mdate').style.display = EDIT_MODE ? 'none' : 'block';
  document.getElementById('mtitle').style.display = EDIT_MODE ? 'none' : 'block';
  document.querySelector('.mcat').style.display = EDIT_MODE ? 'none' : 'flex';
  document.getElementById('mlinks').style.display = EDIT_MODE ? 'none' : 'flex';
  document.getElementById('mtext').style.display = EDIT_MODE ? 'none' : 'block';
  document.getElementById('mgallery').style.display = EDIT_MODE ? 'none' : 'grid';
}

function openEditForStory(story){
  CURRENT_STORY_ID = String(story.id);
  fillEditCategorySelect(story.category || '');
  document.getElementById('e_title').value = story.title || '';
  document.getElementById('e_start').value = story.startDate || '';
  document.getElementById('e_end').value = story.endDate || '';
  document.getElementById('e_link').value = story.externalLink || '';

  const t = (story.fullTextResolved && story.fullTextResolved.trim()) ? story.fullTextResolved : (story.textResolved || '');
  document.getElementById('e_text').value = stripHtml(t);

  const thumb = getThumbUrl(story);
  document.getElementById('e_img').value = thumb || '';

  setEditMode(true);
}

function getStoryById(id){
  return stories.find(s => String(s.id) === String(id));
}

function applySave(){
  if (!CAN_EDIT){ alert('Lecture seule : connecte-toi comme √©diteur pour modifier.'); return; }

  if (!CURRENT_STORY_ID) return;
  const id = CURRENT_STORY_ID;

  const title = document.getElementById('e_title').value.trim();
  const startDate = document.getElementById('e_start').value.trim();
  const endDate = document.getElementById('e_end').value.trim();
  const category = document.getElementById('e_cat').value;
  const externalLink = document.getElementById('e_link').value.trim();
  const img = document.getElementById('e_img').value.trim();
  const text = document.getElementById('e_text').value;

  OVERRIDES = loadOverrides();
  const prev = OVERRIDES[id] && typeof OVERRIDES[id] === 'object' ? OVERRIDES[id] : {};
  const o = Object.assign({}, prev);

  const existsInBase = BASE_STORIES.some(s => String(s.id) === String(id));
  if (!existsInBase) o.__new = true;

  o.title = title || '(sans titre)';
  o.startDate = startDate || '';
  o.endDate = endDate || '';
  o.category = category || '';
  o.externalLink = externalLink || '';
  o.fullTextResolved = text || '';
  o.textResolved = '';

  if (img){
    o.media = [{ id: 1, src: img, caption: '', type: 'Image', thumbPosition: '0,0', externalMediaThumb: '', externalMediaType: '', externalMediaId: '', orderIndex: 10 }];
  } else {
    o.media = [];
  }

  OVERRIDES[id] = o;
  saveOverrides(OVERRIDES);
  debouncedRemoteSave();

  rebuildStoriesFromBase();
  render();

  const s = getStoryById(id);
  if (s){
    openModal(s);
  }
}

function applyDelete(){
  if (!CAN_EDIT){ alert('Lecture seule : connecte-toi comme √©diteur pour supprimer.'); return; }

  const id = CURRENT_STORY_ID;
  if (!id) return;
  if (!confirm('Supprimer cet √©v√©nement ?')) return;

  OVERRIDES = loadOverrides();
  const existsInBase = BASE_STORIES.some(s => String(s.id) === String(id));
  if (existsInBase){
    OVERRIDES[id] = Object.assign({}, (OVERRIDES[id]||{}), { __deleted: true });
  } else {
    delete OVERRIDES[id];
  }
  saveOverrides(OVERRIDES);
  debouncedRemoteSave();
  rebuildStoriesFromBase();
  render();
  closeModal();
}

function nextStoryId(){
  const ids = BASE_STORIES.map(s=>parseInt(s.id,10)).filter(n=>Number.isFinite(n));
  const oids = Object.keys(loadOverrides()).map(k=>parseInt(k,10)).filter(n=>Number.isFinite(n));
  const maxId = Math.max(0, ...ids, ...oids);
  return maxId + 1;
}

function createNewStory(){
  if (!CAN_EDIT){ alert('Lecture seule : connecte-toi comme √©diteur pour ajouter.'); return; }

  const id = String(nextStoryId());
  OVERRIDES = loadOverrides();
  OVERRIDES[id] = { __new: true, title:'(sans titre)', startDate:'', endDate:'', category: (cats[0] ? String(cats[0].id) : ''), fullTextResolved:'', textResolved:'', externalLink:'', tags:'', media:[] };
  saveOverrides(OVERRIDES);
  rebuildStoriesFromBase();
  render();
  const s = getStoryById(id);
  if (s){
    openModal(s);
    openEditForStory(s);
  }
}

// Wire buttons

// --- Supabase auth (viewers vs editors via RLS) ---
window._sb = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
let CAN_EDIT = false;
let LAST_META = { updated_at: null, updated_by: null };

async function refreshAuthUi(){
  const authStatus = document.getElementById("authStatus");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  if (!authStatus) return;

  if (!window._sb){
    authStatus.textContent = "Supabase-js absent.";
    if (loginBtn) loginBtn.disabled = true;
    if (logoutBtn) logoutBtn.disabled = true;
    CAN_EDIT = false;
    applyEditPermissions();
    return;
  }

  const { data } = await window._sb.auth.getSession();
  const sess = data.session;
  if (!sess){
    authStatus.textContent = "Mode: lecture (non connect√©)";
    if (loginBtn) loginBtn.disabled = false;
    if (logoutBtn) logoutBtn.disabled = true;
    CAN_EDIT = false;
    applyEditPermissions();
    return;
  }

  // We rely on RLS to allow/deny writes. Optionally we can probe timeline_editors table if you created it.
  // If the probe fails, we still keep UI in "connect√©" state but edits will be rejected server-side.
  let editor = false;
  try{
    const { data: rows, error } = await window._sb.from("timeline_editors").select("email").eq("email", sess.user.email).limit(1);
    if (!error && Array.isArray(rows) && rows.length) editor = true;
  }catch(e){}

  CAN_EDIT = editor;
  authStatus.textContent = CAN_EDIT ? `Mode: √©dition ‚úÖ (${sess.user.email||sess.user.id})` : `Connect√© (${sess.user.email||sess.user.id}) ‚Äî lecture seule`;
  if (loginBtn) loginBtn.disabled = true;
  if (logoutBtn) logoutBtn.disabled = false;
  applyEditPermissions();
}

function applyEditPermissions(){
  const ids = ["newBtn","editBtn","saveBtn","deleteBtn"];
  for (const id of ids){
    const el = document.getElementById(id);
    if (el) el.style.display = CAN_EDIT ? "" : "none";
  }
}

function updateSbStatus(){
  const el = document.getElementById("sbStatus");
  if (!el) return;
  const ts = LAST_META.updated_at ? new Date(LAST_META.updated_at).toLocaleString() : "‚Äî";
  const who = LAST_META.updated_by ? ("uid " + LAST_META.updated_by) : "‚Äî";
  el.textContent = `Supabase: derni√®re modif ${ts} ‚Ä¢ ${who}`;
}

function updateLastChange(msg){
  const el = document.getElementById("lastChange");
  if (!el) return;
  el.textContent = msg || "";
}

function diffOverrideKeys(a,b){
  const A = a && typeof a === "object" ? a : {};
  const B = b && typeof b === "object" ? b : {};
  const keys = new Set([...Object.keys(A), ...Object.keys(B)]);
  const changed = [];
  for (const k of keys){
    if (JSON.stringify(A[k]) !== JSON.stringify(B[k])) changed.push(k);
  }
  return changed;
}

let _saveTimer = null;
function debouncedRemoteSave(){
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(async ()=>{
    try{
      if (!CAN_EDIT) return;
      await sbSaveOverrides(OVERRIDES);
      const meta = await sbLoadOverrides();
      LAST_META.updated_at = meta.updated_at;
      LAST_META.updated_by = meta.updated_by;
      updateSbStatus();
      updateLastChange("Sauvegard√© sur Supabase ‚úÖ");
    }catch(e){
      updateLastChange("Erreur save Supabase: " + (e.message||String(e)));
      console.warn(e);
    }
  }, 600);
}

async function pullRemoteAndApply(){
  try{
    const meta = await sbLoadOverrides();
    if (meta && meta.data && typeof meta.data === "object"){
      const changed = diffOverrideKeys(OVERRIDES, meta.data);
      OVERRIDES = meta.data;
      saveOverrides(OVERRIDES);
      debouncedRemoteSave();
      rebuildStoriesFromBase();
      render();
      LAST_META.updated_at = meta.updated_at;
      LAST_META.updated_by = meta.updated_by;
      updateSbStatus();
      updateLastChange(changed.length ? `Modifs d√©tect√©es (${changed.length}) : ${changed.slice(0,12).join(", ")}${changed.length>12?"‚Ä¶":""}` : "");
    }
  }catch(e){
    updateLastChange("Reload Supabase impossible: " + (e.message||String(e)));
    console.warn(e);
  }
}

function exportSnapshotGithub(){
  const ymd = new Date().toISOString().slice(0,10);
  const baseBlob = new Blob([JSON.stringify(DATA, null, 2)], {type:"application/json"});
  const baseUrl = URL.createObjectURL(baseBlob);
  const a1 = document.createElement("a");
  a1.href = baseUrl;
  a1.download = `base_${TIMELINE_ID}_${ymd}.json`;
  document.body.appendChild(a1); a1.click(); a1.remove();
  URL.revokeObjectURL(baseUrl);

  const ovBlob = new Blob([JSON.stringify(OVERRIDES, null, 2)], {type:"application/json"});
  const ovUrl = URL.createObjectURL(ovBlob);
  const a2 = document.createElement("a");
  a2.href = ovUrl;
  a2.download = `overrides_${TIMELINE_ID}_${ymd}.json`;
  document.body.appendChild(a2); a2.click(); a2.remove();
  URL.revokeObjectURL(ovUrl);
}

document.addEventListener('DOMContentLoaded', async () => {
  document.getElementById('editBtn').addEventListener('click', () => {
    const s = getStoryById(CURRENT_STORY_ID);
    if (s) openEditForStory(s);
  });
  document.getElementById('saveBtn').addEventListener('click', (e) => { e.preventDefault(); applySave(); });
  document.getElementById('cancelBtn').addEventListener('click', () => { setEditMode(false); });
  document.getElementById('deleteBtn').addEventListener('click', () => { applyDelete(); });
  document.getElementById('newBtn').addEventListener('click', () => { createNewStory(); });
  // --- Auth wiring ---
  await refreshAuthUi();
  if (window._sb){
    window._sb.auth.onAuthStateChange(()=>{ refreshAuthUi(); });
  }
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const authEmail = document.getElementById("authEmail");
  const authCode = document.getElementById("authCode");

  if (loginBtn) loginBtn.addEventListener("click", async ()=>{
    try{
      if (!window._sb) return;
      const email = (authEmail?.value||"").trim();
      const code = (authCode?.value||"").trim();
      if (!email){ alert("Entre un email."); return; }

      if (code){
        const { error } = await window._sb.auth.verifyOtp({ email, token: code, type: "email" });
        if (error) throw error;
        if (authCode) authCode.value = "";
        await refreshAuthUi();
        alert("Connect√© ‚úÖ");
      } else {
        const { error } = await window._sb.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
        if (error) throw error;
        alert("Email envoy√© ‚úÖ (lien magique). Ouvre-le pour te connecter.");
      }
    }catch(e){
      console.warn(e);
      alert("Login impossible: " + (e.message||String(e)));
    }
  });

  if (logoutBtn) logoutBtn.addEventListener("click", async ()=>{
    try{
      if (!window._sb) return;
      await window._sb.auth.signOut();
      CAN_EDIT = false;
      await refreshAuthUi();
      alert("D√©connect√©.");
    }catch(e){
      alert("Logout impossible: " + (e.message||String(e)));
    }
  });

  const snapBtn = document.getElementById("exportSnapshotBtn");
  if (snapBtn) snapBtn.addEventListener("click", exportSnapshotGithub);

  const reloadBtn = document.getElementById("reloadSupabaseBtn");
  if (reloadBtn) reloadBtn.addEventListener("click", pullRemoteAndApply);

  // Initial remote meta + apply overrides (does not affect base display)
  sbLoadOverrides().then(meta=>{
    LAST_META.updated_at = meta.updated_at;
    LAST_META.updated_by = meta.updated_by;
    updateSbStatus();
    if (meta.data && typeof meta.data === "object"){
      OVERRIDES = meta.data;
      saveOverrides(OVERRIDES);
      rebuildStoriesFromBase();
      render();
    }
  }).catch(()=>{});

  // Poll for remote changes
  setInterval(async ()=>{
    try{
      const meta = await sbLoadOverrides();
      if (meta.updated_at && meta.updated_at !== LAST_META.updated_at){
        await pullRemoteAndApply();
      }
    }catch{}
  }, 5000);

});


function parseYear(dateStr) {
  if (!dateStr) return null;
  const m = /^(\d{4})-\d{2}-\d{2}/.exec(dateStr);
  return m ? parseInt(m[1], 10) : null;
}
function fmtDate(dateStr) {
  if (!dateStr) return "";
  return dateStr.split(" ")[0];
}
function stripHtml(s) {
  return (s || "").toString().replace(/<[^>]+>/g, "");
}
function truncate(s, n) {
  s = stripHtml(s).trim();
  if (s.length <= n) return s;
  return s.slice(0, n-1) + "‚Ä¶";
}

function getThumbUrl(story){
  const media = Array.isArray(story.media) ? story.media : [];
  for (const m of media){
    if (!m) continue;
    const t = String(m.type||'').toLowerCase();
    if (t === 'image' && m.src) return m.src;
  }
  // parfois: externalMediaThumb
  for (const m of media){
    if (m && m.externalMediaThumb) return m.externalMediaThumb;
  }
  return '';
}

function buildCategorySelect() {
  const sel = document.getElementById("cat");
  const current = sel.value;
  sel.innerHTML = "";
  const o0 = document.createElement("option");
  o0.value = "";
  o0.textContent = "Toutes les cat√©gories";
  sel.appendChild(o0);

  const sorted = [...cats].sort((a,b)=> (a.title||"").localeCompare(b.title||"", "fr"));
  for (const c of sorted) {
    const o = document.createElement("option");
    o.value = String(c.id);
    o.textContent = c.title || ("Cat " + c.id);
    sel.appendChild(o);
  }
  sel.value = current || "";
}

function filteredStories() {
  const q = document.getElementById("q").value.trim().toLowerCase();
  const catId = document.getElementById("cat").value;
  const y1 = parseInt(document.getElementById("y1").value, 10);
  const y2 = parseInt(document.getElementById("y2").value, 10);

  return stories
    .filter(s => !s.__deleted)
    .slice()
    .sort((a,b)=> (a.startDate||"").localeCompare(b.startDate||""))
    .filter(s => {
      if (catId && String(s.category) !== String(catId)) return false;

      const y = parseYear(s.startDate);
      if (!Number.isNaN(y1) && y !== null && y < y1) return false;
      if (!Number.isNaN(y2) && y !== null && y > y2) return false;

      if (q) {
        const hay = ((s.title||"") + " " + (s.textResolved||"") + " " + (s.fullTextResolved||"") + " " + (s.tags||"")).toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });
}

function render() {
  document.getElementById("pageTitle").textContent = meta.title || "Timeline";
  document.getElementById("pageMeta").textContent =
    (meta.authorName||"") + " ‚Ä¢ " + (meta.startDate||"").split(" ")[0] + " ‚Üí " + (meta.endDate||"").split(" ")[0];

  const items = filteredStories();
  const total = stories.length;

  const yearsAll = stories.map(s=>parseYear(s.startDate)).filter(y=>y!==null);
  const minY = Math.min(...yearsAll);
  const maxY = Math.max(...yearsAll);

  const stats = document.getElementById("stats");
  stats.innerHTML = "";
  const p1 = document.createElement("div"); p1.className="pill"; p1.textContent = items.length + " / " + total + " √©v√©nements affich√©s";
  const p2 = document.createElement("div"); p2.className="pill"; p2.textContent = "Plage: " + minY + " ‚Üí " + maxY;
  stats.appendChild(p1); stats.appendChild(p2);

  const tl = document.getElementById("timeline");
  tl.innerHTML = "";
  for (const s of items) {
    const c = catMap.get(String(s.category||""));
    const color = c && c.colour ? ("#" + c.colour) : "var(--accent)";
    const catTitle = c && c.title ? c.title : "‚Äî";

    const wrap = document.createElement("div");
    wrap.className = "event";

    const card = document.createElement("div");
    card.className = "evt";
    card.addEventListener("click", () => openModal(s));

    const main = document.createElement("div");
    main.className = "evtMain";

    const d = document.createElement("div");
    d.className = "date";
    const sd = fmtDate(s.startDate);
    const ed = fmtDate(s.endDate);
    d.textContent = sd + (ed && ed !== sd ? (" ‚Üí " + ed) : "");
    main.appendChild(d);

    const ti = document.createElement("div");
    ti.className = "title";
    ti.textContent = s.title || "(sans titre)";
    main.appendChild(ti);

    const cat = document.createElement("div");
    cat.className = "cat";
    const dot = document.createElement("span");
    dot.className = "dot";
    dot.style.background = color;
    cat.appendChild(dot);
    const ct = document.createElement("span");
    ct.textContent = catTitle;
    cat.appendChild(ct);
    main.appendChild(cat);

    const prev = document.createElement("div");
    prev.className = "preview";
    const source = (s.fullTextResolved && s.fullTextResolved.trim()) ? s.fullTextResolved : (s.textResolved || "");
    prev.textContent = truncate(source, 240) || "";
    main.appendChild(prev);

    const thumbWrap = document.createElement("div");
    thumbWrap.className = "evtThumb";
    const thumbUrl = getThumbUrl(s);
    if (thumbUrl) {
      const img = document.createElement("img");
      img.loading = "lazy";
      img.decoding = "async";
      img.referrerPolicy = "no-referrer";
      img.src = thumbUrl;
      thumbWrap.appendChild(img);
    } else {
      thumbWrap.classList.add("empty");
    }

    card.appendChild(main);
    card.appendChild(thumbWrap);

    wrap.appendChild(card);
    tl.appendChild(wrap);
  }
}

function openModal(story) {
  CURRENT_STORY_ID = String(story.id);
  setEditMode(false);
  const c = catMap.get(String(story.category||""));
  const color = c && c.colour ? ("#" + c.colour) : "var(--accent)";
  const catTitle = c && c.title ? c.title : "‚Äî";

  const sd = fmtDate(story.startDate);
  const ed = fmtDate(story.endDate);
  document.getElementById("mdate").textContent = sd + (ed && ed !== sd ? (" ‚Üí " + ed) : "");

  document.getElementById("mtitle").textContent = story.title || "(sans titre)";
  document.getElementById("mcat").textContent = catTitle;
  document.getElementById("mdot").style.background = color;

  const links = document.getElementById("mlinks");
  links.innerHTML = "";
  const ext = (story.externalLink || "").trim();
  if (ext) {
    const a = document.createElement("a");
    a.href = ext; a.target="_blank"; a.rel="noopener";
    a.textContent = "Lien externe";
    links.appendChild(a);
  }

  const manual = getManualLinksForStory(story);
  for (const l of manual){
    if (!l || !l.url) continue;
    const a = document.createElement("a");
    a.href = l.url; a.target="_blank"; a.rel="noopener";
    a.textContent = l.title || l.url;
    links.appendChild(a);
  }

  const text = (story.fullTextResolved && story.fullTextResolved.trim()) ? story.fullTextResolved : (story.textResolved || "");
  document.getElementById("mtext").textContent = stripHtml(text);

  const gal = document.getElementById("mgallery");
  gal.innerHTML = "";
  if (Array.isArray(story.media) && story.media.length) {
    for (const m of story.media) {
      if (m.type === "Image" && m.src) {
        const box = document.createElement("div");
        box.className = "thumb";
        const img = document.createElement("img");
        img.src = m.src; img.loading="lazy";
        box.appendChild(img);
        const cap = document.createElement("div");
        cap.className = "cap";
        cap.textContent = (m.caption || "").trim();
        box.appendChild(cap);
        gal.appendChild(box);
      }
    }
  }

  document.getElementById("backdrop").style.display = "block";
  const modal = document.getElementById("modal");
  modal.style.display = "grid";
  modal.setAttribute("aria-hidden", "false");
}

function closeModal() {
  document.getElementById("backdrop").style.display = "none";
  const modal = document.getElementById("modal");
  modal.style.display = "none";
  modal.setAttribute("aria-hidden", "true");
}

async function copyFiltered() {
  const items = filteredStories();
  const payload = { meta: DATA.meta, categories: DATA.categories, stories: items };
  await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
  alert("JSON copi√© ‚úÖ");
}

function resetFilters() {
  document.getElementById("q").value = "";
  document.getElementById("cat").value = "";
  const years = stories.map(s=>parseYear(s.startDate)).filter(y=>y!==null);
  document.getElementById("y1").value = Math.min(...years);
  document.getElementById("y2").value = Math.max(...years);
  render();
}

function exportEdits(){
  const blob = new Blob([JSON.stringify(OVERRIDES, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "tikitoki_edits_1771887.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function importEdits(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      if (!obj || typeof obj !== "object") throw new Error("JSON invalide");
      OVERRIDES = obj;
      saveOverrides(OVERRIDES);
      rebuildStoriesFromBase();
      render();
      alert("Modifications import√©es ‚úÖ");
    } catch(e){
      alert("Import impossible: " + e.message);
    }
  };
  reader.readAsText(file, "utf-8");
}

document.getElementById("q").addEventListener("input", render);
document.getElementById("cat").addEventListener("change", render);
document.getElementById("y1").addEventListener("input", render);
document.getElementById("y2").addEventListener("input", render);
document.getElementById("resetBtn").addEventListener("click", resetFilters);
document.getElementById("copyBtn").addEventListener("click", copyFiltered);

// Import / Export (edits only)
const exportBtn = document.getElementById("exportEditsBtn");
const importBtn = document.getElementById("importEditsBtn");
const importFile = document.getElementById("importFile");
if (exportBtn) exportBtn.addEventListener("click", exportEdits);
if (importBtn && importFile) {
  importBtn.addEventListener("click", ()=> importFile.click());
  importFile.addEventListener("change", ()=>{
    if(importFile.files && importFile.files[0]) importEdits(importFile.files[0]);
  });
}
document.getElementById("backdrop").addEventListener("click", closeModal);
document.getElementById("closeBtn").addEventListener("click", closeModal);
window.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeModal(); });


async function boot(){
  try{
    await loadBaseJson();
    OVERRIDES = loadOverrides();
    rebuildStoriesFromBase();
    buildCategorySelect();
    resetFilters();
    // supabase UI/status (ne bloque pas l'affichage si HS)
    if (typeof refreshAuthUi === 'function') {
      try { await refreshAuthUi(); } catch(e) {}
    }
  } catch(e){
    console.error(e);
    const tl = document.getElementById('timeline');
    if (tl) tl.innerHTML = '';
    const stats = document.getElementById('stats');
    if (stats) stats.innerHTML = '';
    const el = document.createElement('div');
    el.className = 'pill';
    el.textContent = 'Erreur chargement base: ' + (e.message || String(e));
    if (stats) stats.appendChild(el);
  }
}
boot();

</script>
</body>
</html>
