<!--
SC Timeline ‚Äî index.html (page unique + hash routing)

Vues :
- #timeline  => lecture publique
- #edit      => √©dition (si autoris√© Supabase)
-->

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SC Timeline</title>
  <link rel="stylesheet" href="./assets/app.css" />
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- App principale -->
  <script src="./assets/app.js" defer></script>

  <!-- Petit routeur hash (inline, simple) -->
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      function route(){
        const hash = (location.hash || "#timeline").toLowerCase();
        const isEdit = hash === "#edit" || hash.startsWith("#edit");

        // Change le mode attendu par app.js
        document.body.dataset.mode = isEdit ? "edit" : "view";

        // Toggle des vues
        const vTimeline = document.getElementById("view-timeline");
        const vEditor   = document.getElementById("view-editor");
        if (vTimeline && vEditor){
          vTimeline.hidden = isEdit;
          vEditor.hidden   = !isEdit;
        }

        // Petits d√©tails UI
        const modePill = document.getElementById("modePill");
        if (modePill) modePill.textContent = "Mode: " + (isEdit ? "√©dition" : "lecture");

        const editLink = document.getElementById("navEdit");
        const viewLink = document.getElementById("navView");
        if (editLink) editLink.style.display = isEdit ? "none" : "inline-flex";
        if (viewLink) viewLink.style.display = isEdit ? "inline-flex" : "none";
      }

      window.addEventListener("hashchange", () => {
        route();
        // Important: app.js lit data-mode au chargement.
        // Si ton app.js ne r√©agit pas au changement de mode, il faudra recharger la page.
        // Version simple: on force un reload lors du switch.
        // Si tu pr√©f√®res √©viter √ßa, on adaptera app.js.
        location.reload();
      });

      route();
    });
  </script>
</head>

<body
  data-mode="view"
  data-timeline-id="1771887"
  data-supabase-url="https://vubkojqzlmamuuxdjhjv.supabase.co"
  data-supabase-anon-key="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1YmtvanF6bG1hbXV1eGRqaGp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjI5NDQsImV4cCI6MjA4NDMzODk0NH0.IFeKS8MKQhdax0FDtcU1SSuaIDDTzy0zCwld7MsZfng"
>

<header>
  <div class="headerWrap">
    <div>
      <h1 class="hTitle" id="pageTitle">Timeline</h1>
      <div class="hMeta" id="pageMeta"></div>
    </div>
    <div class="hRight">
      <div class="pill" id="modePill">Mode: lecture</div>

      <!-- Navigation hash -->
      <a class="pill" id="navEdit" href="#edit">Ouvrir l‚Äô√©diteur</a>
      <a class="pill" id="navView" href="#timeline" style="display:none">Retour lecture</a>
    </div>
  </div>
</header>

<!-- ===========================
     VUE LECTURE (#timeline)
     =========================== -->
<main id="view-timeline">
  <section class="card">
    <div class="hd">Filtres</div>
    <div class="bd">
      <label class="muted" for="q">Recherche</label>
      <input id="q" placeholder="titre, texte, tags‚Ä¶" />

      <div class="sep"></div>

      <label class="muted" for="cat">Cat√©gorie</label>
      <select id="cat"></select>

      <div class="sep"></div>

      <div class="row">
        <div>
          <label class="muted" for="y1">Ann√©e min</label>
          <input id="y1" type="number" />
        </div>
        <div>
          <label class="muted" for="y2">Ann√©e max</label>
          <input id="y2" type="number" />
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <button id="resetBtn" type="button">R√©initialiser</button>
        <button id="copyBtn" type="button">Copier JSON filtr√©</button>
      </div>

      <div class="sep"></div>

      <div class="row" style="display:none">
        <button id="exportSnapshotBtn" type="button">Export snapshot (GitHub)</button>
        <button id="reloadSupabaseBtn" type="button">Recharger (Supabase)</button>
      </div>

      <div id="stats"></div>
      <div id="sbStatus" class="muted" style="margin-top:10px;font-size:12px"></div>
      <div id="status" class="muted" style="margin-top:4px;font-size:12px"></div>
      <div id="sbEditModeLine" class="muted" style="margin-top:4px;font-size:12px;display:none"></div>

      <div id="authBox" style="display:none">
        <div class="sep"></div>
        <div class="muted" style="font-size:12px;margin-bottom:6px">Connexion (Email OTP / Magic link)</div>
        <input id="authEmail" placeholder="email" />
        <input id="authCode" placeholder="code (si OTP)" />
        <div class="row" style="margin-top:8px">
          <button id="loginBtn" type="button">Se connecter</button>
          <button id="logoutBtn" type="button">Se d√©connecter</button>
        </div>
        <div id="authStatus" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="muted" style="margin-top:10px;font-size:12px">
        Lecture publique. Passe en mode √©dition via <a href="#edit">#edit</a>.
      </div>
    </div>
  </section>

  <section>
    <div id="timeline"></div>
  </section>
</main>

<!-- ===========================
     VUE √âDITION (#edit)
     =========================== -->
<main id="view-editor" hidden>
  <section class="card">
    <div class="hd">Filtres</div>
    <div class="bd">
      <label class="muted" for="q">Recherche</label>
      <input id="q" placeholder="titre, texte, tags‚Ä¶" />

      <div class="sep"></div>

      <label class="muted" for="cat">Cat√©gorie</label>
      <select id="cat"></select>

      <div class="sep"></div>

      <div class="row">
        <div>
          <label class="muted" for="y1">Ann√©e min</label>
          <input id="y1" type="number" />
        </div>
        <div>
          <label class="muted" for="y2">Ann√©e max</label>
          <input id="y2" type="number" />
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <button id="resetBtn" type="button">R√©initialiser</button>
        <button id="copyBtn" type="button">Copier JSON filtr√©</button>
      </div>

      <div class="sep"></div>

      <div class="row" style="margin-top:10px">
        <button id="exportSnapshotBtn" type="button">Export snapshot (GitHub)</button>
        <button id="reloadSupabaseBtn" type="button">Recharger (Supabase)</button>
      </div>

      <div class="sep"></div>

      <div class="panelTitle">√âdition</div>

      <div class="row" style="margin-top:10px">
        <button id="newBtn" type="button">‚ûï Nouvel √©v√®nement</button>
      </div>

      <div id="editActions" style="display:none">
        <div class="row" style="margin-top:10px; gap:10px">
          <button id="saveBtn" type="button">üíæ Enregistrer</button>
          <button id="cancelBtn" type="button">‚úñ Fermer</button>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="deleteBtn" type="button">üóëÔ∏è Supprimer</button>
        </div>
      </div>

      <div id="uiStatus" class="muted" style="margin-top:10px;font-size:12px"></div>

      <div id="stats" style="margin-top:12px"></div>
      <div id="sbStatus" class="muted" style="margin-top:10px;font-size:12px"></div>
      <div id="status" class="muted" style="margin-top:4px;font-size:12px"></div>
      <div id="sbEditModeLine" class="muted" style="margin-top:4px;font-size:12px"></div>

      <div id="authBox" style="margin-top:14px">
        <div class="sep"></div>
        <div class="muted" style="font-size:12px;margin-bottom:8px">Connexion (Email OTP / Magic link)</div>
        <input id="authEmail" type="email" placeholder="email" />
        <div style="height:8px"></div>
        <input id="authCode" type="text" placeholder="code (si OTP)" />
        <div style="height:8px"></div>
        <div class="row">
          <button id="loginBtn" type="button" class="primary">Se connecter</button>
          <button id="logoutBtn" type="button" disabled>Se d√©connecter</button>
        </div>
        <div id="authStatus" class="muted" style="margin-top:8px;font-size:12px">Mode: lecture</div>
        <div class="muted" style="margin-top:6px;font-size:12px">
          ‚ö†Ô∏è Pour √©diter, ton email doit √™tre dans <span class="kbd">timeline_editors</span> (Supabase).
        </div>
      </div>
    </div>
  </section>

  <section>
    <div id="timeline"></div>
  </section>
</main>

<!-- Modale -->
<div id="backdrop" aria-hidden="true"></div>
<div id="modal" aria-hidden="true">
  <div class="mLeft">
    <div class="mTop">
      <div>
        <div class="muted" id="mdate"></div>
        <h2 class="mTitle" id="mtitle"></h2>
        <div class="mCat mcat"><span class="dot" id="mdot"></span><span id="mcat"></span></div>
      </div>
      <div class="mActions">
        <button id="editBtn" type="button">Modifier</button>
        <button id="saveBtn" type="button" style="display:none">Enregistrer</button>
        <button id="cancelBtn" type="button" style="display:none">Annuler</button>
        <button id="deleteBtn" type="button">Supprimer</button>
        <button id="closeBtn" type="button">Fermer</button>
      </div>
    </div>

    <div id="mlinks"></div>
    <div id="mtext"></div>
    <div id="mgallery"></div>

    <div id="editWrap">
      <div class="sep"></div>
      <div class="row">
        <div>
          <label class="muted" for="e_title">Titre</label>
          <input id="e_title" />
        </div>
        <div>
          <label class="muted" for="e_cat">Cat√©gorie</label>
          <select id="e_cat"></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label class="muted" for="e_start">D√©but</label>
          <input id="e_start" placeholder="YYYY-MM-DD" />
        </div>
        <div>
          <label class="muted" for="e_end">Fin</label>
          <input id="e_end" placeholder="YYYY-MM-DD" />
        </div>
      </div>
      <div style="margin-top:10px">
        <label class="muted" for="e_link">Lien externe</label>
        <input id="e_link" />
      </div>
      <div style="margin-top:10px">
        <label class="muted" for="e_img">Image (URL)</label>
        <input id="e_img" />
      </div>
      <div style="margin-top:10px">
        <label class="muted" for="e_text">Texte</label>
        <textarea id="e_text"></textarea>
      </div>
    </div>
  </div>
</div>
</body>
</html>